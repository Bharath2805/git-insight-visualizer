function renderFileTree(e,t=document.getElementById("file-tree")){if(t&&e){t.innerHTML="";for(const[n,o]of Object.entries(e))if("folder"===o.type){const e=document.createElement("div");e.className="folder",e.innerHTML=`\n                <svg class="folder-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="#f0883e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <path d="M1 5v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5"></path>\n                    <path d="M1 5a1 1 0 0 1 1-1h4l2 2h6a1 1 0 0 1 1 1v1"></path>\n                </svg>\n                <span class="folder-name">${n}</span>\n            `;const a=document.createElement("div");a.className="folder-content",o.children&&renderFileTree(o.children,a),e.addEventListener("click",(t=>{t.stopPropagation(),e.classList.toggle("open")})),e.appendChild(a),t.appendChild(e)}else if("file"===o.type){const e=document.createElement("div");let a;switch(e.className="file",o.language){case"javascript":a='<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f0883e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                        <path d="M12 19l-7-7 7-7"></path>\n                        <path d="M19 5v14"></path>\n                    </svg>';break;case"python":a='<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#58a6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                        <path d="M12 5.5v8M5.5 12h13"></path>\n                        <path d="M6 4v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2Z"></path>\n                    </svg>';break;default:a='<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8b949e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>\n                            <path d="M14 2v6h6"></path>\n                            <path d="M16 13H8"></path>\n                            <path d="M16 17H8"></path>\n                            <path d="M10 9H8"></path>\n                        </svg>'}e.innerHTML=`\n                    ${a}\n                    <span class="file-name language-${o.language}">${n}</span>\n                    ${o.outdated?'<span class="outdated-badge">Outdated</span>':""}\n                `,e.addEventListener("click",(()=>{showFileContent(n,o)})),t.appendChild(e)}}else console.error("Invalid parameters for renderFileTree",{parentElement:t,files:e})}function renderVisualization(e){if(console.log("renderVisualization called with data:",e),!e)return void console.error("Invalid repository data for visualization: repoData is null or undefined");if(!e.files)return void console.error("Invalid repository data for visualization: repoData.files is missing",e);const t=document.getElementById("visualization-container");if(!t)return void console.error("Visualization container not found");t.innerHTML="";const n=document.createElement("div");n.className="file-grid",n.style.display="grid",n.style.gridTemplateColumns="repeat(auto-fill, minmax(150px, 1fr))",n.style.gap="15px",n.style.padding="20px",n.style.overflowY="auto",n.style.height="100%";flattenFiles(e.files).forEach((t=>{const o=document.createElement("div");o.className="file-card",o.style.backgroundColor="var(--bg-secondary)",o.style.borderRadius="8px",o.style.padding="15px",o.style.border="1px solid var(--border-color)",o.style.cursor="pointer",o.style.transition="transform 0.2s, box-shadow 0.2s";const a=document.createElement("div");a.style.height="8px",a.style.width="100%",a.style.backgroundColor=getNodeColor({language:t.language,type:t.type}),a.style.borderRadius="4px 4px 0 0",a.style.marginBottom="10px";const i=document.createElement("div");i.textContent=t.name,i.style.fontSize="14px",i.style.fontWeight="bold",i.style.marginBottom="5px",i.style.wordBreak="break-word";const r=document.createElement("div");r.textContent="folder"===t.type?"Folder":t.language||"Unknown",r.style.fontSize="12px",r.style.color="var(--text-secondary)",o.appendChild(a),o.appendChild(i),o.appendChild(r),o.addEventListener("mouseover",(()=>{if(o.style.transform="translateY(-5px)",o.style.boxShadow="0 5px 15px var(--shadow-color)",window.AnimationManager&&"function"==typeof window.AnimationManager.showSpeechBubble){const e="folder"===t.type?`This is the ${t.name} folder`:`This is a ${t.language||"unknown"} file: ${t.name}`;window.AnimationManager.showSpeechBubble(e)}})),o.addEventListener("mouseout",(()=>{o.style.transform="translateY(0)",o.style.boxShadow="none"})),o.addEventListener("click",(()=>{if("folder"===t.type)"function"==typeof addChatMessage&&addChatMessage(`Selected folder: ${t.fullPath}`,!1);else{const n=findFile(e.files,t.fullPath);n&&showFileContent(t.fullPath,n)}})),n.appendChild(o)})),t.appendChild(n),window.selectedNode=null}function flattenFiles(e,t="",n=[]){if(!e)return console.warn("flattenFiles called with null/undefined files"),n;try{for(const[o,a]of Object.entries(e)){const e=t?`${t}/${o}`:o;"file"===a.type?n.push({name:o,type:"file",language:a.language,fullPath:e,outdated:a.outdated}):"folder"===a.type&&(n.push({name:o,type:"folder",fullPath:e}),a.children&&flattenFiles(a.children,e,n))}return n}catch(e){return console.error("Error in flattenFiles:",e),n}}function getNodeColor(e){if(!e)return"var(--text-secondary)";try{if("folder"===e.type)return"var(--accent-orange)";if(e.outdated)return"var(--accent-red)";switch(e.language){case"javascript":return"var(--accent-orange)";case"python":case"json":return"var(--accent-blue)";case"java":return"var(--accent-red)";case"html":case"markdown":return"var(--accent-green)";case"css":return"var(--accent-purple)";default:return"var(--text-secondary)"}}catch(e){return console.error("Error getting node color:",e),"var(--text-secondary)"}}function findFile(e,t){if(!e||!t)return null;try{const n=t.split("/");let o=e;for(let e=0;e<n.length;e++){const t=n[e];if(e===n.length-1)return o[t];if(!o[t]||"folder"!==o[t].type)return null;o=o[t].children}}catch(e){console.error("Error finding file:",e)}return null}function countFiles(e,t=0){if(!e)return t;for(const[n,o]of Object.entries(e))"file"===o.type?t++:"folder"===o.type&&o.children&&(t=countFiles(o.children,t));return t}function calculateLanguageDistribution(e,t={}){if(!e)return t;for(const[n,o]of Object.entries(e))if("file"===o.type){const e=o.language||"unknown";t[e]=(t[e]||0)+1}else"folder"===o.type&&o.children&&(t=calculateLanguageDistribution(o.children,t));return t}function showFileContent(e,t){const n=document.getElementById("file-path"),o=document.getElementById("code-content"),a=document.getElementById("code-viewer"),i=document.querySelector(".visualization-container").parentElement;if(!(n&&o&&a&&i))return void console.error("Required elements not found for showing file content");if(!t||!t.content)return void console.error("Invalid file data or missing content",t);n.textContent=e,o.innerHTML="";t.content.split("\n").forEach(((e,t)=>{const n=document.createElement("div");n.className="code-line",n.innerHTML=`\n            <span class="line-number">${t+1}</span>\n            <span class="line-content">${escapeHtml(e)}</span>\n        `,o.appendChild(n)})),window.AnimationManager&&("function"==typeof window.AnimationManager.loadLanguageAnimation&&window.AnimationManager.loadLanguageAnimation(t.language),"function"==typeof window.AnimationManager.loadCharacterAnimation&&window.AnimationManager.loadCharacterAnimation(t.language),"function"==typeof window.AnimationManager.showSpeechBubble&&window.AnimationManager.showSpeechBubble(`This is a ${t.language} file named ${e}. I can explain it if you ask me!`)),i.style.display="none",a.style.display="flex",window.selectedNode={id:e,type:"file",language:t.language,outdated:t.outdated}}function closeCodeViewer(){const e=document.getElementById("code-viewer"),t=document.querySelector(".visualization-container").parentElement;e&&t?(e.style.display="none",t.style.display="block",window.AnimationManager&&("function"==typeof window.AnimationManager.loadCharacterAnimation&&window.AnimationManager.loadCharacterAnimation("general"),"function"==typeof window.AnimationManager.removeLanguageAnimation&&window.AnimationManager.removeLanguageAnimation()),window.selectedNode=null):console.error("Required elements not found for closing code viewer")}function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}!function(e){const t={initializeAnimations:function(){try{const e=document.getElementById("logo-animation"),t=document.getElementById("loading-animation");e&&(e.innerHTML='<svg width="60" height="60" viewBox="0 0 60 60">\n                    <circle cx="30" cy="30" r="25" fill="#58a6ff">\n                        <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite" />\n                        <animate attributeName="opacity" values="1;0.8;1" dur="2s" repeatCount="indefinite" />\n                    </circle>\n                    <circle cx="30" cy="30" r="15" fill="#0d1117">\n                        <animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite" />\n                    </circle>\n                    <path d="M20,30 L25,25 L35,35 L40,30" stroke="#58a6ff" stroke-width="3" fill="none" stroke-linecap="round">\n                        <animate attributeName="d" values="M20,30 L25,25 L35,35 L40,30;M20,30 L25,35 L35,25 L40,30;M20,30 L25,25 L35,35 L40,30" dur="3s" repeatCount="indefinite" />\n                    </path>\n                </svg>'),t&&(t.innerHTML='<svg width="100" height="100" viewBox="0 0 100 100">\n                    <circle cx="50" cy="50" r="40" stroke="#58a6ff" stroke-width="8" fill="none" stroke-linecap="round">\n                        <animate attributeName="stroke-dasharray" values="1, 250;125, 125;250, 1" dur="1.5s" repeatCount="indefinite" />\n                        <animate attributeName="stroke-dashoffset" values="0;-250;-500" dur="1.5s" repeatCount="indefinite" />\n                    </circle>\n                    <circle cx="50" cy="50" r="30" stroke="#8b949e" stroke-width="4" fill="none" stroke-dasharray="1, 150" stroke-dashoffset="0">\n                        <animate attributeName="stroke-dashoffset" values="0;150;0" dur="3s" repeatCount="indefinite" />\n                    </circle>\n                </svg>')}catch(e){console.error("Error initializing SVG animations:",e)}},loadLanguageAnimation:function(e){try{const t=document.getElementById("language-animation");if(!t)return;t.innerHTML="";let n="#58a6ff";switch(e){case"javascript":n="#f0db4f";break;case"python":n="#3572A5";break;case"java":n="#b07219";break;case"html":n="#e34c26";break;case"css":n="#563d7c";break;case"json":n="#5dbcd2";break;case"markdown":n="#083fa1";break;default:n="#58a6ff"}t.innerHTML=`<svg width="150" height="150" viewBox="0 0 150 150">\n                <rect x="25" y="25" width="100" height="100" fill="${n}" opacity="0.3" rx="15" ry="15">\n                    <animate attributeName="opacity" values="0.2;0.4;0.2" dur="3s" repeatCount="indefinite" />\n                </rect>\n                <rect x="45" y="45" width="60" height="60" fill="${n}" opacity="0.6" rx="10" ry="10">\n                    <animate attributeName="opacity" values="0.5;0.8;0.5" dur="2s" repeatCount="indefinite" />\n                    <animate attributeName="width" values="55;60;55" dur="4s" repeatCount="indefinite" />\n                    <animate attributeName="height" values="55;60;55" dur="4s" repeatCount="indefinite" />\n                    <animate attributeName="x" values="47;45;47" dur="4s" repeatCount="indefinite" />\n                    <animate attributeName="y" values="47;45;47" dur="4s" repeatCount="indefinite" />\n                </rect>\n                <text x="75" y="85" font-family="monospace" font-size="16" text-anchor="middle" fill="white">${e}</text>\n            </svg>`,t.classList.add("fade-in")}catch(e){console.error("Error loading language animation:",e)}},loadCharacterAnimation:function(e){try{const t=document.getElementById("character-container");if(!t)return;t.innerHTML="",t.classList.remove("float","bounce");let n="",o="float";switch(e){case"javascript":n='\n                        <svg width="120" height="120" viewBox="0 0 120 120">\n                            <circle cx="60" cy="60" r="50" fill="#f0db4f" />\n                            <circle cx="40" cy="50" r="7" fill="#000" />\n                            <circle cx="80" cy="50" r="7" fill="#000" />\n                            <path d="M40,75 Q60,90 80,75" stroke="#000" stroke-width="4" fill="none" />\n                            <text x="60" y="40" font-family="monospace" font-size="10" text-anchor="middle">JS</text>\n                        </svg>\n                    ',o="float";break;case"python":n='\n                        <svg width="120" height="120" viewBox="0 0 120 120">\n                            <path d="M20,60 Q60,20 100,60 Q60,100 20,60" fill="#3572A5" />\n                            <circle cx="40" cy="50" r="7" fill="#fff" />\n                            <circle cx="80" cy="50" r="7" fill="#fff" />\n                            <path d="M45,80 Q60,70 75,80" stroke="#fff" stroke-width="3" fill="none" />\n                            <text x="60" y="40" font-family="monospace" font-size="10" text-anchor="middle" fill="white">PY</text>\n                        </svg>\n                    ',o="bounce";break;case"java":n='\n                        <svg width="120" height="120" viewBox="0 0 120 120">\n                            <rect x="35" y="30" width="50" height="70" rx="10" fill="#b07219" />\n                            <rect x="45" y="20" width="30" height="20" rx="5" fill="#b07219" />\n                            <circle cx="40" cy="50" r="5" fill="#fff" />\n                            <circle cx="80" cy="50" r="5" fill="#fff" />\n                            <path d="M50,80 L70,80" stroke="#fff" stroke-width="3" />\n                            <text x="60" y="40" font-family="monospace" font-size="10" text-anchor="middle" fill="white">JAVA</text>\n                        </svg>\n                    ',o="float";break;case"json":n='\n                        <svg width="120" height="120" viewBox="0 0 120 120">\n                            <rect x="30" y="30" width="60" height="60" rx="5" fill="#5dbcd2" />\n                            <circle cx="45" cy="50" r="5" fill="#fff" />\n                            <circle cx="75" cy="50" r="5" fill="#fff" />\n                            <path d="M45,80 Q60,70 75,80" stroke="#fff" stroke-width="3" fill="none" />\n                            <text x="60" y="100" font-family="monospace" font-size="10" text-anchor="middle" fill="#5dbcd2">JSON</text>\n                        </svg>\n                    ',o="float";break;case"markdown":n='\n                        <svg width="120" height="120" viewBox="0 0 120 120">\n                            <rect x="30" y="20" width="60" height="80" rx="5" fill="#083fa1" />\n                            <line x1="40" y1="40" x2="80" y2="40" stroke="#fff" stroke-width="2" />\n                            <line x1="40" y1="50" x2="80" y2="50" stroke="#fff" stroke-width="2" />\n                            <line x1="40" y1="60" x2="80" y2="60" stroke="#fff" stroke-width="2" />\n                            <line x1="40" y1="70" x2="60" y2="70" stroke="#fff" stroke-width="2" />\n                            <circle cx="45" cy="30" r="5" fill="#fff" />\n                            <circle cx="75" cy="30" r="5" fill="#fff" />\n                            <text x="60" y="105" font-family="monospace" font-size="10" text-anchor="middle" fill="#083fa1">MD</text>\n                        </svg>\n                    ',o="float";break;default:n='\n                        <svg width="120" height="120" viewBox="0 0 120 120">\n                            <circle cx="60" cy="60" r="50" fill="#58a6ff" />\n                            <circle cx="40" cy="50" r="7" fill="#fff" />\n                            <circle cx="80" cy="50" r="7" fill="#fff" />\n                            <path d="M40,75 Q60,90 80,75" stroke="#fff" stroke-width="4" fill="none" />\n                            <text x="60" y="40" font-family="monospace" font-size="10" text-anchor="middle" fill="white">CODE</text>\n                        </svg>\n                    ',o="float"}t.innerHTML=n,t.classList.add(o),t.classList.add("fade-in")}catch(e){console.error("Error loading character animation:",e)}},showSpeechBubble:function(e,t=5e3){try{const n=document.getElementById("speech-bubble");if(!n)return;n.textContent=e,n.classList.add("active"),setTimeout((()=>{n.classList.remove("active")}),t)}catch(e){console.error("Error showing speech bubble:",e)}},showLoading:function(){try{const e=document.getElementById("loading-overlay");e&&e.classList.add("active")}catch(e){console.error("Error showing loading overlay:",e)}},hideLoading:function(){try{const e=document.getElementById("loading-overlay");e&&e.classList.remove("active")}catch(e){console.error("Error hiding loading overlay:",e)}},playCelebration:function(e="success"){try{const e=document.getElementById("character-container");if(!e)return;e.classList.add("bounce"),setTimeout((()=>{e.classList.remove("bounce")}),1e3)}catch(e){console.error("Error playing celebration animation:",e)}}};"undefined"!=typeof module&&module.exports&&(module.exports=t),"function"==typeof define&&define.amd&&define([],(function(){return t})),e.AnimationManager=t}("undefined"!=typeof window?window:this),document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelectorAll(".theme-btn");e.forEach((t=>{t.addEventListener("click",(()=>{e.forEach((e=>e.classList.remove("active"))),t.classList.add("active"),document.body.classList.remove("theme-dark","theme-cyberpunk","theme-forest","theme-sunset"),document.body.classList.add(t.dataset.theme),localStorage.setItem("theme",t.dataset.theme)}))}))})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("close-code-btn");e&&e.addEventListener("click",closeCodeViewer)}));const chatInput=document.getElementById("chat-input"),chatSubmit=document.getElementById("chat-submit"),chatBody=document.getElementById("chat-body"),explainBtn=document.getElementById("explain-btn"),explainDetailBtn=document.getElementById("explain-detail-btn"),MAX_HISTORY_LENGTH=5;let conversationHistory=[];const LOADING_MESSAGES=["Thinking deeply about your question...","Analyzing repository context...","Crafting a thoughtful response...","Diving into the code details...","Preparing insights...","Connecting the dots...","Gathering repository wisdom..."];function getRandomLoadingMessage(){return LOADING_MESSAGES[Math.floor(Math.random()*LOADING_MESSAGES.length)]}function updateTypingIndicator(e){if(!e)return;const t=e.querySelector(".typing-message");t&&(t.textContent=getRandomLoadingMessage())}function addChatMessage(e,t){if(!chatBody)return;const n=document.createElement("div");n.className="chat-message "+(t?"user-message":"ai-message"),t?n.textContent=e:n.innerHTML=formatChatResponse(e),chatBody.appendChild(n),chatBody.scrollTop=chatBody.scrollHeight,conversationHistory.push({role:t?"user":"assistant",content:e}),conversationHistory.length>2*MAX_HISTORY_LENGTH&&(conversationHistory=conversationHistory.slice(2*-MAX_HISTORY_LENGTH))}function formatChatResponse(e){let t=e;if(e.includes("function")&&e.includes("Lines")){let t='<div class="code-analysis">';const n=e.split(/Lines \d+-\d+/),o=e.match(/Lines \d+-\d+/g)||[];if(o.length>0){t+='<h3 class="analysis-header">Code Analysis Summary</h3>';for(let e=0;e<o.length;e++)t+='<div class="analysis-section">',t+=`<div class="section-header">${o[e]}</div>`,n[e+1]&&(t+=`<div class="section-content">${n[e+1]}</div>`),t+="</div>"}else t+=e;return t+="</div>",t}return t=t.replace(/```([a-z]*)([\s\S]*?)```/g,((e,t,n)=>`<div class="code-block">\n            <div class="code-header">${t||"code"}</div>\n            <pre class="code-content language-${t||"none"}">${n.trim()}</pre>\n        </div>`)),t=t.replace(/^\s*[-*]\s+(.+)$/gm,"<li>$1</li>"),t=t.replace(/(<li>.*<\/li>)(?!\s*<li>)/gs,"<ul>$1</ul>"),t=t.replace(/^#{1,6}\s+(.+)$/gm,((e,t)=>{const n=e.trim().indexOf(" ");return`<h${n} class="chat-heading">${t}</h${n}>`})),t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*(.*?)\*/g,"<em>$1</em>"),t}async function handleChatSubmit(){const e=chatInput.value.trim();if(!e)return;addChatMessage(e,!0),chatInput.value="";const t=document.createElement("div");t.className="chat-message ai-message typing-indicator",t.innerHTML=`\n        <div class="typing-animation">\n            <span>.</span><span>.</span><span>.</span>\n        </div>\n        <div class="typing-message">${getRandomLoadingMessage()}</div>\n    `,chatBody.appendChild(t),chatBody.scrollTop=chatBody.scrollHeight;const n=setInterval((()=>{updateTypingIndicator(t)}),3e3);try{const o=new AbortController,a=setTimeout((()=>o.abort()),3e4);let i={};window.selectedNode&&(i.selectedNode={id:window.selectedNode.id,type:window.selectedNode.type,language:window.selectedNode.language});const r={message:e,repoData:window.repoData?{name:window.repoData.name,fullName:window.repoData.fullName,description:window.repoData.description}:null,context:i,history:conversationHistory.slice(2*-MAX_HISTORY_LENGTH)},s=await fetch("/api/openai/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:o.signal});if(clearTimeout(a),clearInterval(n),!s.ok)throw new Error("Failed to get response from AI");const l=await s.json();t.parentNode&&chatBody.removeChild(t),addChatMessage(l.response,!1),window.AnimationManager&&"function"==typeof window.AnimationManager.showSpeechBubble&&window.AnimationManager.showSpeechBubble("I've answered your question in the chat below!")}catch(e){console.error("Error getting AI response:",e),clearInterval(n),t.parentNode&&chatBody.removeChild(t),"AbortError"===e.name?addChatMessage("Sorry, the request took too long. The repository might be complex or the connection is slow. Please try again.",!1):addChatMessage("Sorry, I encountered an error while processing your request. Please check your connection and try again.",!1)}}async function explainFile(e=!1){const t=document.getElementById("file-path");if(!t)return;const n=t.textContent;if(!n)return;"function"==typeof showLoading&&showLoading(),addChatMessage(`Explaining ${e?"in detail":""}: ${n}...`,!1);const o=document.createElement("div");o.className="chat-message ai-message typing-indicator",o.innerHTML="\n        <span>.</span><span>.</span><span>.</span>\n    ",chatBody.appendChild(o),chatBody.scrollTop=chatBody.scrollHeight;try{const t=document.getElementById("code-content");if(!t)throw new Error("Code content element not found");const a=t.innerText,i=await fetch("/api/openai/explain-file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:n,fileContent:a,detailed:e})});if(!i.ok)throw new Error("Failed to get explanation from AI");const r=await i.json();o.parentNode&&chatBody.removeChild(o),addChatMessage(e?`Here's my line-by-line explanation of ${n}:`:`Here's my explanation of ${n}:`,!1),addChatMessage(r.explanation,!1),window.AnimationManager&&"function"==typeof window.AnimationManager.showSpeechBubble&&window.AnimationManager.showSpeechBubble(e?"I've analyzed this file line by line! Check the chat for details.":"I've analyzed this file! Check the chat for a summary.")}catch(e){console.error("Error getting file explanation:",e),o.parentNode&&chatBody.removeChild(o),addChatMessage("Sorry, I encountered an error while analyzing this file. Please try again.",!1)}finally{"function"==typeof hideLoading&&hideLoading()}}chatSubmit&&chatSubmit.addEventListener("click",handleChatSubmit),chatInput&&chatInput.addEventListener("keyup",(e=>{"Enter"===e.key&&handleChatSubmit()})),explainBtn&&explainBtn.addEventListener("click",(()=>{explainFile(!1)})),explainDetailBtn&&explainDetailBtn.addEventListener("click",(()=>{explainFile(!0)}));const repoInput=document.getElementById("repo-input"),analyzeBtn=document.getElementById("analyze-btn"),mainContent=document.getElementById("main-content"),repoTitle=document.getElementById("repo-title"),repoDescription=document.getElementById("repo-description"),filesCount=document.getElementById("files-count"),lastUpdated=document.getElementById("last-updated"),loadingOverlay=document.getElementById("loading-overlay"),structureBtn=document.getElementById("structure-btn"),dependenciesBtn=document.getElementById("dependencies-btn"),insightsBtn=document.getElementById("insights-btn");let selectedNode=null,repoData=null;function addUIElements(){const e=document.createElement("div");e.className="stream-indicator",e.innerHTML='\n    <div class="spinner"></div>\n    <div>Loading repository data...</div>\n  ',document.body.appendChild(e);const t=document.createElement("button");t.className="code-view-toggle",t.innerHTML='\n    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n      <polyline points="16 18 22 12 16 6"></polyline>\n      <polyline points="8 6 2 12 8 18"></polyline>\n    </svg>\n  ',t.setAttribute("title","Toggle Code View"),document.body.appendChild(t),t.addEventListener("click",toggleCodeView)}function showStreamLoading(e){const t=document.querySelector(".stream-indicator");t&&(t.querySelector("div:last-child").textContent=e||"Processing...",t.classList.add("active"))}function hideStreamLoading(){const e=document.querySelector(".stream-indicator");e&&e.classList.remove("active")}function toggleCodeView(){const e=document.getElementById("code-viewer"),t=document.querySelector(".visualization-content");e&&t&&("flex"===e.style.display?(e.style.display="none",t.style.display="block"):window.selectedNode&&"file"===window.selectedNode.type?(e.style.display="flex",t.style.display="none"):addChatMessage("Please select a file from the repository first.",!1))}function showLoading(e="Analyzing repository... Please wait."){if(loadingOverlay){const t=loadingOverlay.querySelector(".loading-message");t&&(t.textContent=e),loadingOverlay.classList.add("active")}}function hideLoading(){loadingOverlay&&loadingOverlay.classList.remove("active")}function validateRepoUrl(e){return/^https?:\/\/(www\.)?github\.com\/[a-zA-Z0-9-]+\/[a-zA-Z0-9-]+\/?$/.test(e)}async function analyzeRepositoryWithStreaming(e){if(e){showStreamLoading("Connecting to GitHub...");try{const t=e.replace(/^https?:\/\/(www\.)?github\.com\//,"").split("/"),n=t[0],o=t[1];if(!n||!o)throw new Error("Invalid repository URL format. Please use format: https://github.com/username/repository");addChatMessage(`Starting analysis of ${n}/${o}...`,!1),showStreamLoading("Fetching repository structure...");const a=await fetch(`/api/github/repo?owner=${n}&repo=${o}`);if(!a.ok)throw new Error(`API error: ${a.status} ${a.statusText}`);showStreamLoading("Processing repository data...");const i=await a.json();window.repoData=i,displayRepositoryInfo(i),renderFileTree(i.files),renderVisualization(i),document.getElementById("main-content").style.display="grid",addChatMessage(`Repository analysis complete! Found ${countFiles(i.files)} files. Ask me questions about the code structure or any specific file.`,!1),hideStreamLoading()}catch(e){console.error("Error analyzing repository:",e),addChatMessage(`Error analyzing repository: ${e.message}`,!1),hideStreamLoading()}}}async function enhancedChatSubmit(){const e=document.getElementById("chat-input"),t=e.value.trim();if(!t)return;addChatMessage(t,!0),e.value="";const n=document.getElementById("chat-body"),o=document.createElement("div");o.className="chat-message ai-message typing-indicator",o.innerHTML="\n    <span>.</span><span>.</span><span>.</span>\n  ",n.appendChild(o),n.scrollTop=n.scrollHeight,showStreamLoading("Processing your question...");try{let e={};window.selectedNode&&(e.selectedNode={id:window.selectedNode.id,type:window.selectedNode.type,language:window.selectedNode.language,outdated:window.selectedNode.outdated});const n=await fetch("/api/openai/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,repoData:window.repoData?{name:window.repoData.name,fullName:window.repoData.fullName,description:window.repoData.description}:null,context:e})});if(!n.ok)throw new Error("Failed to get response from AI");const a=await n.json();o.parentNode&&o.parentNode.removeChild(o),addChatMessage(a.response,!1),hideStreamLoading(),window.AnimationManager&&"function"==typeof window.AnimationManager.showSpeechBubble&&window.AnimationManager.showSpeechBubble("I've answered your question in the chat below!")}catch(e){console.error("Error getting AI response:",e),o.parentNode&&o.parentNode.removeChild(o),addChatMessage("Sorry, I encountered an error while processing your request. Please try again.",!1),hideStreamLoading()}}async function analyzeRepository(e){if(mainContent&&(mainContent.style.display="none"),!validateRepoUrl(e))return showLoading("Invalid GitHub repository URL. Please check the format."),void setTimeout(hideLoading,3e3);showLoading(`Preparing to analyze ${e}...`);try{const t=e.replace(/^https?:\/\/(www\.)?github\.com\//,"").split("/"),n=t[0],o=t[1];if(!n||!o)throw new Error("Invalid repository URL format. Please use format: https://github.com/username/repository");showLoading(`Connecting to GitHub for ${n}/${o}...`);const a=new AbortController,i=setTimeout((()=>a.abort()),12e4);try{showLoading(`Fetching repository details for ${n}/${o}...`);const e=await fetch(`/api/github/repo?owner=${n}&repo=${o}`,{signal:a.signal});if(clearTimeout(i),!e.ok)switch(e.status){case 404:throw new Error("Repository not found. Please check the URL.");case 403:throw new Error("Access forbidden. The repository might be private or rate limit exceeded.");default:throw new Error(`API error: ${e.status} ${e.statusText}`)}if(showLoading(`Processing repository data for ${n}/${o}...`),repoData=await e.json(),window.repoData=repoData,!repoData||!repoData.files)throw new Error("No repository data received. The repository might be empty.");displayRepositoryInfo(repoData),renderFileTree(repoData.files),renderVisualization(repoData),mainContent&&(mainContent.style.display="grid"),showLoading("Repository analysis complete!"),setTimeout(hideLoading,1500)}catch(e){clearTimeout(i),"AbortError"===e.name?showLoading("Repository analysis timed out. This might be a large repository."):showLoading(`Error: ${e.message}`),setTimeout(hideLoading,3e3),console.error("Repository analysis error:",e)}}catch(e){console.error("Error analyzing repository:",e),showLoading(`Error: ${e.message}`),setTimeout(hideLoading,3e3)}}function displayRepositoryInfo(e){if(e){if(repoTitle&&(repoTitle.textContent=e.fullName||"Unknown Repository"),repoDescription&&(repoDescription.textContent=e.description||"No description available"),filesCount){let t=countFiles(e.files);filesCount.textContent=`${t} files`}if(lastUpdated&&e.lastUpdated){const t=new Date(e.lastUpdated);lastUpdated.textContent=`Last updated: ${t.toLocaleDateString()}`}}}function countFiles(e,t=0){if(!e)return t;for(const[n,o]of Object.entries(e))"file"===o.type?t++:"folder"===o.type&&o.children&&(t=countFiles(o.children,t));return t}document.addEventListener("DOMContentLoaded",(function(){addUIElements(),analyzeBtn&&analyzeBtn.addEventListener("click",(function(){const e=repoInput?repoInput.value.trim():"";e&&analyzeRepositoryWithStreaming(e)}));const e=document.getElementById("chat-submit");e&&e.addEventListener("click",enhancedChatSubmit);const t=document.getElementById("chat-input");t&&t.addEventListener("keyup",(function(e){"Enter"===e.key&&enhancedChatSubmit()}));try{const e=localStorage.getItem("theme");e&&(document.body.className=e,document.querySelectorAll(".theme-btn").forEach((t=>{t.classList.remove("active"),t.dataset.theme===e&&t.classList.add("active")}))),void 0!==window.AnimationManager&&"function"==typeof window.AnimationManager.initializeAnimations&&window.AnimationManager.initializeAnimations()}catch(e){console.error("Error during initialization:",e)}structureBtn&&structureBtn.addEventListener("click",(()=>{structureBtn.classList.add("active"),dependenciesBtn&&dependenciesBtn.classList.remove("active"),insightsBtn&&insightsBtn.classList.remove("active"),window.repoData&&window.repoData.files&&renderVisualization(window.repoData)})),dependenciesBtn&&dependenciesBtn.addEventListener("click",(()=>{structureBtn&&structureBtn.classList.remove("active"),dependenciesBtn.classList.add("active"),insightsBtn&&insightsBtn.classList.remove("active"),window.repoData&&window.repoData.files&&renderVisualization(window.repoData)})),insightsBtn&&insightsBtn.addEventListener("click",(()=>{structureBtn&&structureBtn.classList.remove("active"),dependenciesBtn&&dependenciesBtn.classList.remove("active"),insightsBtn.classList.add("active"),window.repoData&&window.repoData.files&&renderVisualization(window.repoData)})),repoInput&&repoInput.addEventListener("keyup",(e=>{"Enter"===e.key&&analyzeBtn&&analyzeBtn.click()}))}));